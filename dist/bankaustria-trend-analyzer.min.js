/*! bankaustria-trend-analyzer 07-01-2015 */
!function(){"use strict";function a(){function a(a){var b=a.Betrag,c=b.replace(/\./,""),d=c.replace(/\,/,".");return d}this.parser=new b,this.convert=function(b){var c=this.parser.parse(b.Buchungsdatum),d=a(b),f=parseFloat(d),g=new e;return g.bookingdate=c.getTime(),g.accountchange=parseFloat(f.toFixed(2)),g.bookingtext=b["Buchungstext "],g.hash=g.hashCode(),g},this.convertAll=function(a){var b=[];for(var c in a){var d=this.convert(a[c]);b.push(d),d.artificialId=b.length,d.id=b.length}return b}}function b(){function a(a){return a.indexOf("/")>0?a.split("/"):a.indexOf(".")>0?a.split("."):[]}this.parse=function(b){var c=a(b),d=parseInt(c[2],10),e=parseInt(c[1],10)-1,f=parseInt(c[0],10);return new Date(d,e,f)}}function c(){this.asObjects=function(a){return $.csv.toObjects(a,{separator:";"})}}function d(b){function d(b){var d=new c,e=d.asObjects(b),f=new a;return f.convertAll(e)}b.bookingitems=new f,b.$watch("currentbalance",function(a){b.calculateFromEnd(a)}),b.currentbalance=0,b.startingbalance=0,b.orderProp="artificialId",b.displayType="number:2",b.setFile=function(a){b["import"](a.files[0]),b.$apply()},b.loadData=function(a){var e=a.target.result;if(e.indexOf("Buchungsdatum;Valutadatum;Buchungstext ;Interne Notiz;")>=0){var f=d(e);b.bookingitems.merge(f),b.calculateFromEnd(b.currentbalance),b.$apply()}if(e.indexOf("artificialId;bookingdate;accountchange;bookingtext;currentbalance;previousbalance;hash")>=0){var g=new c,h=g.asObjects(e);h.every(function(a){a.accountchange=b.parseBalance(a.accountchange),a.currentbalance=b.parseBalance(a.currentbalance),a.previousbalance=b.parseBalance(a.previousbalance),a.bookingdate=parseInt(a.bookingdate,10),a.artificialId=parseInt(a.artificialId,10),a.id=parseInt(a.id,10),a.bookingdate=parseInt(a.bookingdate,10),a.hash=parseInt(a.hash,10)}),b.bookingitems.merge(h),b.currentbalance=b.bookingitems.items[b.bookingitems.items.length-1].currentbalance,b.startingbalance=b.bookingitems.items[0].previousbalance,b.$apply()}},b["import"]=function(a){console.log(a.name);var c=new FileReader;c.readAsText(a),c.onload=b.loadData,c.onerror=function(a){alert("Unable to read "+a.fileName)}},b.parseBalance=function(a){if(void 0===a||null===a||0===a)return 0;if(Number(a)===a)return a;var b=a.replace(/\,/,".");return parseFloat(b)},b.containsValidSpecialCharacters=function(a){if(0===a||Number(a)===a)return!1;if("undefined"==typeof a||0===a.length)return!0;if("-"==a)return!0;var b=a[a.length-1];return b.match(/\.|,/)?!0:!1},b.calculateFromEnd=function(a){if(!b.containsValidSpecialCharacters(a)){var c=b.parseBalance(a);b.currentbalance=c;for(var d=b.bookingitems.items.length-1;d>=0;d--)b.bookingitems.items[d].currentbalance=c,c-=b.bookingitems.items[d].accountchange,c=parseFloat(c.toFixed(2)),b.bookingitems.items[d].previousbalance=c;b.startingbalance=c}},b.getColor=function(a){return 0===a?"":a>0?"green":"red"},b.getColorBalance=function(a){return a>=0?"":"red"}}var e=function(){this.artificialId=0,this.bookingdate=0,this.accountchange=0,this.bookingtext="",this.currentbalance=0,this.previousbalance=0,this.hash=0};String.prototype.hashCode=function(){var a,b,c,d=0;if(0===this.length)return d;for(a=0,c=this.length;c>a;a++)b=this.charCodeAt(a),d=(d<<5)-d+b,d|=0;return d},Number.prototype.hashCode=function(){var a=0;return a=(a<<5)-a+this,a|=0},e.prototype.hashCode=function(){var a=this.bookingdate.hashCode();return a=31*a+this.accountchange.hashCode(),a=31*a+this.bookingtext.hashCode()};var f=function(){this.items=[]};f.prototype.isBookingdateInTheMiddleOfArray=function(a){return a.bookingdate>this.items[0].bookingdate&&a.bookingdate<this.items[this.items.length-1].bookingdate},f.prototype.isBookingdateYounger=function(a){return a.bookingdate>this.items[this.items.length-1].bookingdate},f.prototype.isBookingdateOlder=function(a){return a.bookingdate<=this.items[0].bookingdate},f.prototype.addItem=function(a){0===this.items.length?this.items.push(a):this.isBookingdateInTheMiddleOfArray(a)?this.innerMerge(a):this.isBookingdateYounger(a)?this.items.push(a):this.isBookingdateOlder(a)&&this.items.unshift(a)},f.prototype.innerMerge=function(a){for(var b=0;b<this.items.length;b++){var c=a.bookingdate<this.items[b].bookingdate;if(c){var d=this.items.splice(b);return this.items.push(a),void this.items.push.apply(this.items,d)}}},f.prototype.resetArtificialIds=function(){for(var a=0;a<this.items.length;a++)this.items[a].artificialId=a},f.prototype.itemExists=function(a,b){for(var c in a)if(a[c]===b.hash)return!0;return!1},f.prototype.merge=function(a){var b=this.items.map(function(a){return a.hash});for(var c in a){var d=a[c];this.itemExists(b,d)||this.addItem(d)}this.resetArtificialIds()},d.$inject=["$scope"];var g=angular.module("bankaustriaTrendAnalyzer",["ngSanitize","ngCsv"]);g.controller("BankListController",["$scope",d]),g.config(["$compileProvider",function(a){a.debugInfoEnabled(!0)}])}(window,document);